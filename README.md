# Приложение для интеграции данных о тендерах с amoCRM

Данное приложение автоматизирует процесс получения информации о победителях тендеров из Excel-файлов, поступающих на электронную почту, и последующую загрузку/обновление этих данных в amoCRM в виде сделок, компаний и задач, а также сохранение информации в локальную базу данных PostgreSQL.

## Основная логика работы

Приложение работает в бесконечном цикле со следующими шагами:

1.  **Подключение к почтовому ящику**: Используется IMAP для подключения к Gmail (настраивается через `.env`).
2.  **Поиск новых писем**: Каждые `CHECK_INTERVAL_SECONDS` (настраивается, по умолчанию 3600 секунд) проверяется наличие новых писем от определенного отправителя (`winners@tenderhub.ru`) с определенной темой (`Прогнозируемые победители`) и Excel-вложением.
3.  **Обработка файла**:
    * Если найдено новое письмо с Excel-файлом (сравнивается дата выгрузки из имени файла с датой последнего обработанного файла), файл скачивается.
    * **Парсинг Excel-файла**: Данные из файла парсятся с помощью библиотеки `pandas`. Извлекается информация о победителях тендеров, включая ИНН, ссылки на закупки, бюджеты, контактные данные и т.д.
    * **Запись в PostgreSQL**: Распарсенные данные (в формате `DBStatePurchase`) записываются в базу данных PostgreSQL. Используется операция `INSERT ... ON CONFLICT ... DO UPDATE` для обновления существующих записей по уникальному номеру закупки.
    * **Обработка для amoCRM**: Распарсенные данные также передаются для обработки и загрузки в amoCRM.
4.  **Цикл повторяется**.

## Взаимодействие с amoCRM

Логика взаимодействия с amoCRM вынесена в модуль `src.processing.amocrm_processor.py` и использует `src.amo.client.AmoClient` для API-запросов.

### Инициализация `AmoClient`
* При первом создании экземпляра `AmoClient` (внутри `async with AmoClient() as amo_client_instance:`) происходит инициализация справочников:
    * Загружаются ID всех воронок и их этапов.
    * Загружаются ID всех пользователей amoCRM.
    * Загружаются ID всех пользовательских полей для сделок и компаний.
    * Эти ID кэшируются в объекте `AmoClient` для последующего использования.

### Обработка каждой строки из Excel (`_handle_lead_processing`)

Для каждой строки из Excel-файла (представляющей победу в тендере) выполняется следующая логика:

1.  **Фильтр по бюджету**: Обрабатываются только строки, где "Обеспечение контракта" (бюджет) **больше** `settings.MIN_LEAD_BUDGET` (100 000).
2.  **Определение имени сделки**: Имя сделки = "Победитель" из Excel.
3.  **Фильтрация создания сделок (для закрепленных за менеджерами Алена/Новикова Евгения)**:
    * Если у победителя есть ИНН, выполняется поиск существующих компаний в amoCRM по этому ИНН.
    * Если найдена хотя бы одна компания, ответственным менеджером которой является "Алена" или "Новикова Евгения" (согласно списку `settings.EXCLUDE_RESPONSIBLE_USERS`), то **новая сделка для этого победителя не создается**, и обработка данной строки Excel прекращается.
4.  **Поиск существующей сделки**:
    * В воронке `settings.PIPELINE_NAME_GOSZAKAZ` ("Гос.заказ - прогрев клиента") ищется существующая сделка по точному совпадению имени победителя.
    * При поиске исключаются сделки, ответственным по которым являются пользователи из списка `settings.EXCLUDE_RESPONSIBLE_USERS` ("Алена", "Новикова Евгения").
5.  **Если сделка найдена**:
    * Получается ее ID, текущий ответственный и текущий бюджет.
    * **Обновление бюджета сделки**:
        * Если новое значение "Обеспечение контракта" из Excel не равно 0 и отличается от текущего бюджета сделки, бюджет сделки обновляется.
        * Если новое значение "Обеспечение контракта" равно 0, текущий бюджет сделки **не изменяется**.
    * **Добавление примечания о победе**:
        * Формируется подробное текстовое примечание, включающее: Ссылку на закупку (АЕ), Наименование победителя (L), ИНН (J), дату итогов (АС), Наименование заказчика (С), НМЦК (D), Обеспечение контракта (E), Обеспечение гарантийных обязательств (F), Окончание контракта (AD), Цену победителя (G), контактные данные (N-Y), Преимущества СМП (H), Статус СМП (I).
        * Это примечание **всегда добавляется** к найденной сделке, представляя информацию о текущей обработанной "победе" из Excel.
    * **Перемещение сделки вверх по канбану**: После добавления примечания (или обновления бюджета, если оно произошло) у сделки обновляется системное поле `updated_at`, что приводит к ее перемещению вверх в списке на канбан-доске.
    * **Постановка задачи**:
        * Текст задачи: "Пришло обновление из базы победителей" (дополненный именем победителя, номером закупки и ID сделки).
        * Если у сделки есть ответственный (и он не "НЕРАЗОБРАННЫЕ ЗАЯВКИ"), задача ставится на этого ответственного.
        * Если ответственный не проставлен или это "НЕРАЗОБРАННЫЕ ЗАЯВКИ", задача ставится на пользователя "Анастасия Попова" (имя из `settings.USER_NAME_DEFAULT_TASK_ASSIGN_POPOVA`).
        * Срок выполнения задачи: через `settings.TASK_COMPLETE_OFFSET_MINUTES` (10 минут) от текущего времени.
6.  **Если сделка не найдена**:
    * `is_new_lead` устанавливается в `True`.
    * **Создание новой компании**:
        * Если у победителя есть ИНН, **всегда создается новая компания** в amoCRM. Имя новой компании берется из поля "Победитель", также устанавливается ИНН. Поиск существующей компании перед созданием не производится, что приводит к созданию дубликатов компаний, если компания с таким ИНН уже существует.
        * ID созданной компании используется для привязки к сделке.
        * Если ИНН отсутствует, компания не создается и не привязывается.
    * **Создание новой сделки**:
        * Сделка создается в воронке `settings.PIPELINE_NAME_GOSZAKAZ` на этапе `settings.STATUS_NAME_POBEDITELI` ("Победители").
        * **Ответственный**: При создании новой сделки ответственный явно не указывается, чтобы он был назначен по умолчанию в amoCRM ("НЕРАЗОБРАННЫЕ ЗАЯВКИ").
        * **Поля сделки**:
            * Название сделки: "Победитель" (столбец L).
            * Бюджет (БГ): "Обеспечение контракта" (столбец E).
            * Пользовательское поле "ИНН" (из `settings.CUSTOM_FIELD_NAME_INN_LEAD`): "ИНН победителя" (столбец J).
            * Пользовательское поле "Ссылка на закупку" (из `settings.CUSTOM_FIELD_NAME_PURCHASE_LINK_LEAD`): "Номер закупки" (A) + "Закупка в ЕИС" (AE).
    * **Добавление примечания о победе**: Аналогично случаю с найденной сделкой, всегда добавляется подробное примечание.
    * **Перемещение сделки вверх по канбану**: После создания сделки и добавления примечания обновляется `updated_at`.
    * **Постановка задачи**:
        * Текст задачи: "Пришло обновление из базы победителей" (дополненный).
        * Получается фактический ответственный только что созданной сделки.
        * Если ответственный - "НЕРАЗОБРАННЫЕ ЗАЯВКИ" (по ID) или не определен, задача ставится на "Анастасия Попова".
        * Если у новой сделки назначен другой ответственный, задача ставится на него.
        * Срок выполнения задачи: 10 минут.

## Структура Проекта

* `main.py`: Точка входа в приложение, основной цикл обработки почты.
* `src/`: Основной каталог с исходным кодом.
    * `settings/`: Конфигурация приложения.
        * `__init__.py`: Загрузка настроек из `.env` с использованием Pydantic. Определяет такие параметры, как доступы к почте, amoCRM, БД, имена полей, пользователей, воронок, статусов и т.д.
        * `enums.py`: Определяет перечисление `AppMode` (режимы работы приложения: DEBUG, PRODUCTION, TEST).
    * `mail/`: Модули для работы с почтой и файлами.
        * `mail_connector.py`: Класс `Gmail` для подключения к почтовому ящику и извлечения последнего письма с Excel-вложением.
        * `file_parser.py`: Класс `ExcelParser` для парсинга данных из Excel-файла с использованием `pandas` и валидации через Pydantic модели.
    * `db/`: Модули для работы с базой данных.
        * `abc.py`: Абстрактный класс `DB` для интерфейса базы данных.
        * `postgres/db.py`: Класс `PostgresDB`, реализующий интерфейс `DB` для работы с PostgreSQL с использованием `aiopg`.
        * `__init__.py`: Экспортирует `PostgresDB`.
    * `amo/`: Модули для взаимодействия с amoCRM.
        * `client.py`: Класс `AmoClient` – асинхронный клиент для работы с amoCRM API v4. Включает методы для получения ID сущностей (воронки, статусы, пользователи, поля), поиска и создания сделок, компаний, добавления примечаний, обновления сделок и создания задач. Реализует ограничение частоты запросов (`AsyncLimiter`).
        * `schemas.py`: Pydantic-модели `StatePurchase` и `DBStatePurchase` для валидации и структурирования данных, получаемых из Excel. `DBStatePurchase` наследуется от `StatePurchase` и добавляет поля `extraction_dt` и `purchase_number`.
    * `processing/`: Модули с основной бизнес-логикой.
        * `amocrm_processor.py`: Содержит функцию `process_parsed_data_for_amocrm` и вспомогательные функции (`_handle_lead_processing`, `_create_task`, `generate_note_text_for_win`), реализующие основную логику обработки данных из Excel и их загрузки/обновления в amoCRM.

## Настройка и Запуск

1.  **Установить зависимости**:
    ```bash
    poetry install
    ```
  
2.  **Создать файл `.env`**: В корне проекта создать файл `.env` и заполнить его необходимыми данными по примеру:
    ```env
    IMAP_EMAIL=your_email@example.com
    IMAP_PASSWORD=your_email_password
    AMO_SUBDOMAIN=your_amo_subdomain
    AMO_LONG_TERM_TOKEN=your_amo_token
    DB_USER=your_db_user
    DB_PASSWORD=your_db_password
    DB_NAME=your_db_name
    DB_HOST=localhost
    DB_PORT=5432
    MODE=test # или production, debug
    
    # Опциональные тестовые креды для amoCRM
    # TEST_AMO_SUBDOMAIN=your_test_amo_subdomain
    # TEST_AMO_LONG_TERM_TOKEN=your_test_amo_token
    ```
3.  **Настроить PostgreSQL**: Убедиться, что база данных PostgreSQL запущена и доступна с указанными кредами. При необходимости создать таблицу `state_purchases`.
4.  **Запуск приложения**:
    ```bash
    python main.py
    ```

## Важные Функции и их Логика

* **`main.main()` (`main.py`)**:
    * Инициализирует почтовый клиент.
    * В бесконечном цикле проверяет почту, получает последний Excel-файл.
    * Сравнивает дату из имени файла с датой последнего обработанного файла, чтобы избежать повторной обработки.
    * Вызывает парсер для извлечения данных.
    * Вызывает `PostgresDB.write_purchases()` для записи данных в БД.
    * Вызывает `process_parsed_data_for_amocrm()` для обработки данных в amoCRM.

* **`ExcelParser.parse_for_db()` (`src/mail/file_parser.py`)**:
    * Читает Excel-файл в DataFrame.
    * Преобразует столбцы с датами в нужный формат.
    * Заменяет NaN на None.
    * Добавляет `extraction_dt` (дата из имени файла).
    * Валидирует каждую строку с помощью модели `DBStatePurchase`.
    * Возвращает список объектов `DBStatePurchase`.

* **`AmoClient` (`src/amo/client.py`)**:
    * **`_ensure_ids_initialized()`**: При первом обращении загружает и кэширует ID воронок, статусов, пользователей, кастомных полей сделок и компаний.
    * **`search_companies_by_inn()`**: Ищет компании по ИНН.
    * **`create_company()`**: Создает новую компанию. По ТЗ, вызывается всегда при создании сделки с ИНН, не проверяя наличие существующей.
    * **`search_leads_by_name()`**: Ищет сделки по имени в указанной воронке, с возможностью исключения сделок по ID ответственных.
    * **`create_lead()`**: Создает новую сделку. Включает логику *обязательного* создания новой компании (если передан `company_inn`) и ее привязки. Заполняет стандартные и пользовательские поля.
    * **`add_note_to_lead()`**: Добавляет текстовое примечание к сделке.
    * **`update_lead()`**: Обновляет сделку (используется для бюджета и `updated_at`).
    * **`create_task_for_lead()`**: Создает задачу для сделки.
    * **`get_lead_details()`**: Получает детали сделки, включая ответственного.

* **`process_parsed_data_for_amocrm()` и `_handle_lead_processing()` (`src/processing/amocrm_processor.py`)**:
    * Оркестрируют основную логику работы с amoCRM для каждой строки из Excel.
    * Выполняют фильтрацию по бюджету и по ответственным менеджерам (для предотвращения создания сделок).
    * Вызывают методы `AmoClient` для поиска/создания сделок и компаний.
    * Вызывают `_create_task()` для постановки задач.
    * Вызывают `generate_note_text_for_win()` и `AmoClient.add_note_to_lead()` для добавления примечаний.
    * Вызывают `AmoClient.update_lead()` для обновления `updated_at` (перемещение сделки вверх).

* **`_create_task()` (`src/processing/amocrm_processor.py`)**:
    * Определяет ответственного для задачи на основе ТЗ (новая сделка и "Неразобранные", или существующая сделка и ее ответственный/Анастасия Попова).
    * Формирует текст задачи: "Пришло обновление из базы победителей" + детали.
    * Устанавливает срок выполнения задачи (+10 минут).
    * Вызывает `AmoClient.create_task_for_lead()`.

## Результат Работы Приложения

* Новые победы из Excel-файлов (после фильтрации) появляются в amoCRM как сделки в воронке "Гос.заказ - прогрев клиента" на этапе "Победители".
* Для каждой такой сделки создается связанная компания по ИНН.
* В сделку добавляется подробное примечание с информацией о победе.
* Для сделки ставится задача согласно правилам ТЗ.
* При добавлении нового примечания (т.е. при обработке каждой новой победы для существующей сделки или при создании новой) сделка перемещается вверх в списке на канбан-доске.
* Данные о победах также сохраняются/обновляются в базе данных PostgreSQL.